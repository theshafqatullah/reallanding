# Apply Routes Implementation Documentation

## Overview
This document describes the implementation of the agent and agency application routes in the `/app/(apply)` directory.

## Architecture

### Route Structure
```
(apply)/
├── layout.tsx                 # Main layout with auth hydrator
├── page.tsx                   # Selection page (agent vs agency)
├── agent/
│   └── page.tsx              # Agent application form
└── agency/
    └── page.tsx              # Agency application form
```

### Profile Creation Flow
```
User Selection
    ↓
Application Form (Agent/Agency)
    ↓
Profile Created with Logged-in User ID
    ↓
Profile Completion Page
```

## Features

### 1. Apply Landing Page (`/apply`)
- Displays two options: Individual Agent or Agency
- Clean card-based UI with icons
- Direct navigation to respective application forms

### 2. Agent Application Form (`/apply/agent`)
**Required Information Collected:**
- Personal Information
  - First Name
  - Last Name
  - Phone Number
  - Timezone

- Professional Information
  - License Number
  - Years of Experience
  - Designation/Title
  - Company Name (optional)
  - Typical Response Time

- Expertise & Services
  - Specializations (types of properties)
  - Service Areas (geographic coverage)
  - Languages Spoken
  - Certifications

- About You
  - Professional Bio (minimum 50 characters)

- Location
  - City, State, Country

- Contact Preferences
  - Preferred Contact Method

- Social Media & Web
  - Website URL
  - LinkedIn Profile
  - Instagram Handle
  - Facebook Page

### 3. Agency Application Form (`/apply/agency`)
**Required Information Collected:**
- Company Information
  - Company Name
  - Registration/License Number
  - Established Year
  - Team Size
  - Typical Response Time

- Contact Person
  - First Name
  - Last Name
  - Phone Number

- Professional Information
  - Specializations
  - Property Types Handled
  - Service Areas
  - Languages Spoken

- About Your Agency
  - Company Description

- Location
  - City, State, Country, Timezone

- Contact Preferences
  - Preferred Contact Method

- Regulatory Information
  - Broker Name
  - Broker License
  - RERA Registration

- Social Media & Web
  - Website URL
  - LinkedIn Profile
  - Instagram Handle
  - Facebook Page

## Database Integration

### Users Collection Schema
The application uses the existing `Users` collection with the following key fields:

**Auto-Generated Fields:**
- `$id`: Unique document ID (created by Appwrite)
- `user_id`: Auth user ID (matched with logged-in user)
- `email`: User's email
- `account_status`: "pending" (default for new applications)
- `profile_completion_percentage`: Set to 40% after initial application
- `is_active`: true
- `is_premium`: false
- `is_verified`: false

**Profile Fields:**
- `first_name`, `last_name`: User name
- `user_type`: "agent" or "agency"
- `phone`: Contact number
- `license_number`: Professional license
- `company_name`: Company name
- `bio`: Professional description
- And many more detailed fields for agents and agencies

## Implementation Details

### Authentication
- Uses custom `AuthContext` for managing user state
- Leverages Appwrite's `account` service
- Checks if user is logged in before allowing application submission
- Redirects to signin if needed

### Form Validation
- Uses `react-hook-form` with Zod schema validation
- Client-side validation with error messages
- Real-time validation on blur
- Field-by-field error reporting

### Profile Creation Logic
```typescript
// 1. Create initial profile with basic info
const userProfile = await usersService.create({
  user_id: user.$id,  // Logged-in user ID
  email: user.email,
  first_name: data.first_name,
  last_name: data.last_name,
  phone: data.phone,
  user_type: UserType.AGENT, // or AGENCY
});

// 2. Update profile with full application data
await usersService.update(userProfile.$id, {
  // All application form fields...
  account_status: 'pending',
  profile_completion_percentage: 40,
});
```

### Document ID Strategy
- **Document ID**: Automatically generated by Appwrite (unique)
- **User ID Reference**: Stored in `user_id` field (matches logged-in user)
- This allows:
  - Easy retrieval by `user_id`
  - One profile per logged-in user
  - Profile URL accessible as `/profile/{documentId}`

## API Usage

### Create User Profile
```typescript
await usersService.create({
  user_id: string,
  email: string,
  first_name: string,
  last_name: string,
  phone: string,
  user_type: UserType.AGENT | UserType.AGENCY,
});
```

### Update User Profile
```typescript
await usersService.update(documentId: string, data: {
  // Any fields from Users collection
  license_number?: string,
  experience_years?: number,
  // etc...
});
```

### Retrieve User Profile
```typescript
// By document ID
const profile = await usersService.getById(documentId);

// By user ID (recommended for current user)
const profile = await usersService.getByUserId(userId);
```

## Data Flow

1. **User navigates to `/apply`**
   - Sees selection between Agent and Agency

2. **User selects option (e.g., Agent)**
   - Navigates to `/apply/agent`
   - Auth context checks if user is logged in
   - If not logged in, redirects to signin

3. **User fills application form**
   - Form validates each field
   - Shows error messages for invalid inputs
   - Collects all required information

4. **User submits form**
   - Create initial profile with basic info
   - Update profile with full application data
   - Set account_status to "pending"
   - Set profile_completion_percentage to 40%

5. **Redirect to completion page**
   - `/profile/{documentId}/complete`
   - Shows submission confirmation
   - Displays completion steps
   - Links to document upload

## Error Handling

- Try-catch blocks for all async operations
- User-friendly error messages via toast notifications
- Redirect to apply page on critical errors
- Console logging for debugging

## User Experience

### For Agents
- Streamlined form focused on agent-specific information
- Clear sections for professionalism and credentials
- Real-time validation feedback

### For Agencies
- Company-focused questions
- Team management indicators
- Regulatory compliance fields

### General
- Progress indication through section headers
- Helpful descriptions for each field
- Pre-filled defaults where applicable
- Mobile-responsive layout
- Loading states during submission

## Next Steps (Not Yet Implemented)

1. **Document Upload** (`/profile/{profileId}/upload-documents`)
   - Upload ID, license, certifications
   - Document verification

2. **Background Check**
   - Automated or manual review

3. **Profile Approval**
   - Admin review and approval

4. **Email Notifications**
   - Confirmation emails
   - Status updates

## Environment Variables Required

```env
NEXT_PUBLIC_APPWRITE_ENDPOINT=https://fra.cloud.appwrite.io/v1
NEXT_PUBLIC_APPWRITE_PROJECT_ID=6945350d002dafb82d34
```

## Database Configuration

The application expects:
- Database ID: "main"
- Users Collection ID: "users"
- Permissions already configured in Appwrite

## Files Modified/Created

### Created Files:
- `app/(apply)/layout.tsx`
- `app/(apply)/page.tsx`
- `app/(apply)/agent/page.tsx`
- `app/(apply)/agency/page.tsx`
- `app/(profile)/profile/[profileId]/complete/page.tsx`
- `lib/auth-context.tsx`

### Modified/Required Services:
- `services/users.ts` (existing)
- `types/appwrite.ts` (existing)
- `services/appwrite.ts` (existing)

## Future Enhancements

1. **Multi-step form** - Break into smaller steps
2. **Draft saving** - Auto-save form progress
3. **File uploads** - Logo, banner images
4. **Payment integration** - Premium plan selection
5. **Email verification** - Email confirmation required
6. **Admin dashboard** - Application review interface
7. **Analytics** - Track application completion rates

## Testing Recommendations

1. Test with and without authentication
2. Test form validation with invalid data
3. Test profile creation and retrieval
4. Test redirect flows
5. Test error handling
6. Test on mobile devices
7. Test social media URL validation

## Security Considerations

1. User can only create profile for themselves (using `user.$id`)
2. Form data validated on client and server
3. Sensitive information (license numbers) stored securely
4. Background checks required before full approval
5. Account status set to "pending" by default
